---

import Layout from "@/layouts/layout.astro";
import PageAudioPlayer from "@/components/quran/halaman/audio-player";
import { getQuranPageData } from "@/lib/api/quran";

export const prerender = false;

const { id } = Astro.params;
if (!id) throw new Error("Missing page id");

const pageNumber = Number(id);
if (!Number.isFinite(pageNumber) || pageNumber < 1 || pageNumber > 604) {
  return Astro.redirect("/quran/halaman/1");
}

const page = await getQuranPageData(pageNumber);

const prevPage = pageNumber > 1 ? pageNumber - 1 : null;
const nextPage = pageNumber < 604 ? pageNumber + 1 : null;

const surahLabel =
  page.meta.surahs?.length
    ? page.meta.surahs.map((s) => `${s.name} (${s.number})`).join(" • ")
    : "—";

const surahNameById = new Map(
  (page.meta.surahs ?? []).map((s) => [s.number, s.name])
);
---

<script define:vars={{ pageNumber }}>
  const key = "hm:last_read";
  try {
    localStorage.setItem(
      key,
      JSON.stringify({
        type: "page",
        id: pageNumber,
        label: `Halaman ${pageNumber}`,
      })
    );
  } catch {}
</script>


<Layout
  title={`Al-Qur’an — Halaman ${pageNumber}`}
  description={`Halaman ${pageNumber} • Juz ${page.meta.juz} • ${surahLabel}`}
>
  <main class="mx-auto w-full max-w-4xl px-4 py-10 md:px-6">
    <header class="mb-6">
      <p class="text-xs font-medium tracking-wide text-muted-foreground">
        HALAMAN {pageNumber} • JUZ {page.meta.juz || "-"}
      </p>
      <h1 class="mt-2 text-2xl font-semibold">Tampilan Halaman Mushaf</h1>
      <p class="mt-2 text-sm text-muted-foreground">{surahLabel}</p>
    </header>

    <div class="mb-6 flex items-center justify-between">
      {prevPage ? (
        <a
          href={`/quran/halaman/${prevPage}`}
          class="rounded-lg border border-border/60 px-3 py-2 text-sm transition hover:border-border hover:bg-accent"
        >
          Sebelumnya
        </a>
      ) : null}

      {nextPage ? (
        <a
          href={`/quran/halaman/${nextPage}`}
          class="rounded-lg border border-border/60 px-3 py-2 text-sm transition hover:border-border hover:bg-accent"
        >
          Berikutnya
        </a>
      ) : null}
    </div>

    {page.verses.length ? (
      <>
        <div class="mb-6">
          <PageAudioPlayer client:idle verses={page.verses} />
        </div>

        <section class="rounded-2xl border border-border/60 bg-card p-6">
        <div class="text-right text-3xl leading-loose">
          {page.verses.map((v) => (
            <span>
              {v.teksArab}{" "}
              <span class="mx-1 align-middle text-xs text-muted-foreground">
                ({v.verseKey})
              </span>{" "}
            </span>
          ))}
        </div>

        <div class="mt-8 grid gap-6 border-t border-border/60 pt-6 md:grid-cols-2">
          <div class="space-y-3">
            <h2 class="text-sm font-semibold">Latin</h2>
            <div class="space-y-3 text-sm text-muted-foreground">
              {page.verses.map((v) => (
                <div class="space-y-1">
                  <span class="text-xs text-muted-foreground">
                    Surah {surahNameById.get(v.chapterId) ?? `Surah ${v.chapterId}`} Ayat{" "}
                    {v.verseKey.split(":")[1]}
                  </span>
                  <p>{v.teksLatin}</p>
                </div>
              ))}
            </div>
          </div>

          <div class="space-y-3">
            <h2 class="text-sm font-semibold">Terjemahan</h2>
            <div class="space-y-3 text-sm leading-relaxed">
              {page.verses.map((v) => (
                <div class="space-y-1">
                  <span class="text-xs text-muted-foreground">
                    Surah {surahNameById.get(v.chapterId) ?? `Surah ${v.chapterId}`} Ayat{" "}
                    {v.verseKey.split(":")[1]}
                  </span>
                  <p>{v.teksIndonesia}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
      </section>
      </>
    ) : (
      <div class="rounded-2xl border border-border/60 bg-card p-6">
        <p class="text-sm text-muted-foreground">
          Tidak ada data untuk halaman ini.
        </p>
      </div>
    )}
  </main>
</Layout>
