---
import Layout from "@/layouts/layout.astro";
import PageAudioPlayer from "@/components/quran/halaman/audio-player";
import { getQuranPageData } from "@/lib/api/quran";

export const prerender = false;

const { id } = Astro.params;
if (!id) throw new Error("Missing page id");

const pageNumber = Number(id);
if (!Number.isFinite(pageNumber) || pageNumber < 1 || pageNumber > 604) {
  return Astro.redirect("/quran/halaman/1");
}

const page = await getQuranPageData(pageNumber);

const prevPage = pageNumber > 1 ? pageNumber - 1 : null;
const nextPage = pageNumber < 604 ? pageNumber + 1 : null;

const surahLabel =
  page.meta.surahs?.length
    ? page.meta.surahs.map((s) => `${s.name} (${s.number})`).join(" - ")
    : "-";

const surahNameById = new Map(
  (page.meta.surahs ?? []).map((s) => [s.number, s.name])
);
---

<script define:vars={{ pageNumber }}>
  const key = "hm:last_read";
  try {
    localStorage.setItem(
      key,
      JSON.stringify({
        type: "page",
        id: pageNumber,
        label: `Halaman ${pageNumber}`,
      })
    );
  } catch {}
</script>


<Layout
  title={`Al-Qur'an - Halaman ${pageNumber}`}
  description={`Halaman ${pageNumber} - Juz ${page.meta.juz} - ${surahLabel}`}
>
  <main class="mx-auto w-full max-w-4xl px-4 py-12 md:px-6">
    <section class="illumination-panel p-6 md:p-8">
      <div class="relative z-10 space-y-4">
        <p class="ink-eyebrow text-muted-foreground">
          Halaman {pageNumber} - Juz {page.meta.juz || "-"}
        </p>
        <h1 class="text-2xl font-semibold md:text-3xl">
          Tampilan Halaman Mushaf
        </h1>
        <p class="text-sm text-muted-foreground">{surahLabel}</p>

        <div class="mt-8">
          <PageAudioPlayer client:idle verses={page.verses} />
        </div>
      </div>
    </section>

    {page.verses.length ? (
      <>
        <div class="pt-6 flex items-center justify-between gap-3">
          {prevPage ? (
            <a
              href={`/quran/halaman/${prevPage}`}
              class="rounded-full border border-border/60 bg-background/70 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground transition hover:border-primary/50 hover:bg-background/80"
            >
              Sebelumnya
            </a>
          ) : (
            <span />
          )}

          {nextPage ? (
            <a
              href={`/quran/halaman/${nextPage}`}
              class="rounded-full border border-border/60 bg-background/70 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground transition hover:border-primary/50 hover:bg-background/80"
            >
              Berikutnya
            </a>
          ) : (
            <span />
          )}
        </div>

        <section class="mt-6 rounded-2xl border border-border/60 bg-background/70 p-6">
          <div class="text-right text-3xl leading-loose" lang="ar" dir="rtl">
            {page.verses.map((v) => (
              <span>
                {v.teksArab}{" "}
                <span class="mx-1 align-middle text-xs text-muted-foreground">
                  ({v.verseKey})
                </span>{" "}
              </span>
            ))}
          </div>

          <div class="mt-8 grid gap-6 border-t border-border/60 pt-6 md:grid-cols-2">
            <div class="space-y-3">
              <h2 class="text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground">
                Latin
              </h2>
              <div class="space-y-3 text-sm text-muted-foreground">
                {page.verses.map((v) => (
                  <div class="space-y-1">
                    <span class="text-xs text-muted-foreground">
                      Surah {surahNameById.get(v.chapterId) ?? `Surah ${v.chapterId}`} Ayat{" "}
                      {v.verseKey.split(":")[1]}
                    </span>
                    <p>{v.teksLatin}</p>
                  </div>
                ))}
              </div>
            </div>

            <div class="space-y-3">
              <h2 class="text-xs font-semibold uppercase tracking-[0.3em] text-muted-foreground">
                Terjemahan
              </h2>
              <div class="space-y-3 text-sm leading-relaxed">
                {page.verses.map((v) => (
                  <div class="space-y-1">
                    <span class="text-xs text-muted-foreground">
                      Surah {surahNameById.get(v.chapterId) ?? `Surah ${v.chapterId}`} Ayat{" "}
                      {v.verseKey.split(":")[1]}
                    </span>
                    <p>{v.teksIndonesia}</p>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </section>
      </>
    ) : (
      <div class="mt-6 rounded-2xl border border-border/60 bg-background/70 p-6">
        <p class="text-sm text-muted-foreground">Tidak ada data untuk halaman ini.</p>
      </div>
    )}
  </main>
</Layout>
