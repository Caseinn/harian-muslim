---
import Layout from "@/layouts/layout.astro";
import AudioPlayer from "@/components/quran/[id]/audio-player";
import { getSurahDetail, getSurahList } from "@/lib/api/quran";

export const prerender = true;

export async function getStaticPaths() {
  const surahList = await getSurahList();
  return surahList.map((surah) => ({
    params: { id: String(surah.nomor) },
  }));
}

const { id } = Astro.params;
if (!id) throw new Error("Missing surah id");

const surahId = Number(id);
if (!Number.isFinite(surahId) || surahId < 1 || surahId > 114) {
  return Astro.redirect("/quran");
}

const surah = await getSurahDetail(surahId);
const surahList = await getSurahList();

const prevId = surahId > 1 ? surahId - 1 : null;
const nextId = surahId < 114 ? surahId + 1 : null;

const prevName = prevId
  ? surahList.find((item) => item.nomor === prevId)?.namaLatin ??
    `Surah ${prevId}`
  : null;
const nextName = nextId
  ? surahList.find((item) => item.nomor === nextId)?.namaLatin ??
    `Surah ${nextId}`
  : null;
---

<script define:vars={{ surahNomor: surah.nomor, surahNama: surah.namaLatin }}>
  const key = "hm:last_read";
  try {
    localStorage.setItem(
      key,
      JSON.stringify({
        type: "surah",
        id: surahNomor,
        label: `${surahNama} (Surah ${surahNomor})`,
      })
    );
  } catch {}
</script>

<Layout
  title={`Al-Qur'an - ${surah.namaLatin}`}
  description={`${surah.arti} - ${surah.tempatTurun} - ${surah.jumlahAyat} ayat`}
>
  <main class="mx-auto w-full max-w-4xl px-4 py-12 md:px-6">
    <section class="illumination-panel p-6 md:p-8">
      <div class="relative z-10">
        <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
          <div class="space-y-2">
            <p class="ink-eyebrow text-muted-foreground">Surah {surah.nomor}</p>
            <h1 class="text-3xl font-semibold md:text-4xl">{surah.namaLatin}</h1>
            <p class="text-sm text-muted-foreground">
              {surah.arti} - {surah.tempatTurun} - {surah.jumlahAyat} ayat
            </p>
          </div>

          <div class="text-right self-center" lang="ar" dir="rtl">
            <div class="text-4xl font-semibold text-primary">{surah.nama}</div>
          </div>
        </div>

        <div class="my-6 ornament-divider"></div>

        <AudioPlayer client:idle audioFull={surah.audioFull} />
      </div>
    </section>

    <section class="mt-8 space-y-6">
      {surah.ayat.map((a) => (
        <article class="rounded-2xl border border-border/60 bg-background/70 p-5">
          <div class="flex items-center justify-between text-xs text-muted-foreground">
            <span>Ayat {a.nomorAyat}</span>
          </div>

          <p class="mt-4 text-right text-2xl leading-relaxed" lang="ar" dir="rtl">
            {a.teksArab}
          </p>
          <p class="mt-3 text-sm text-muted-foreground">{a.teksLatin}</p>
          <p class="mt-3 text-sm leading-relaxed">{a.teksIndonesia}</p>
        </article>
      ))}
    </section>

    <div class="mt-10 grid gap-3 sm:grid-cols-2">
      {prevId ? (
        <a
          href={`/quran/${prevId}`}
          class="rounded-2xl border border-border/60 bg-background/70 px-4 py-4 text-left text-sm transition hover:border-primary/50 hover:bg-background/80"
        >
          <span class="block text-xs uppercase tracking-[0.3em] text-muted-foreground">
            Sebelumnya
          </span>
          <span class="mt-2 block text-base font-semibold">{prevName}</span>
        </a>
      ) : null}

      {nextId ? (
        <a
          href={`/quran/${nextId}`}
          class="rounded-2xl border border-border/60 bg-background/70 px-4 py-4 text-left text-sm transition hover:border-primary/50 hover:bg-background/80 sm:text-right"
        >
          <span class="block text-xs uppercase tracking-[0.3em] text-muted-foreground">
            Selanjutnya
          </span>
          <span class="mt-2 block text-base font-semibold">{nextName}</span>
        </a>
      ) : null}
    </div>
  </main>
</Layout>
