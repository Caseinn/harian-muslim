---
import Layout from "@/layouts/layout.astro";
import AudioPlayer from "@/components/quran/[id]/audio-player";
import { getSurahDetail, getSurahList } from "@/lib/api/quran";

export const prerender = false;

const { id } = Astro.params;
if (!id) throw new Error("Missing surah id");

const surahId = Number(id);
if (!Number.isFinite(surahId) || surahId < 1 || surahId > 114) {
  return Astro.redirect("/quran");
}

const surah = await getSurahDetail(surahId);
const surahList = await getSurahList();

const prevId = surahId > 1 ? surahId - 1 : null;
const nextId = surahId < 114 ? surahId + 1 : null;

const prevName = prevId
  ? surahList.find((item) => item.nomor === prevId)?.namaLatin ??
    `Surah ${prevId}`
  : null;
const nextName = nextId
  ? surahList.find((item) => item.nomor === nextId)?.namaLatin ??
    `Surah ${nextId}`
  : null;
---

<script define:vars={{ surahNomor: surah.nomor, surahNama: surah.namaLatin }}>
  const key = "hm:last_read";
  try {
    localStorage.setItem(
      key,
      JSON.stringify({
        type: "surah",
        id: surahNomor,
        label: `${surahNama} (Surah ${surahNomor})`,
      })
    );
  } catch {}
</script>

<Layout
  title={`Al-Qur’an — ${surah.namaLatin}`}
  description={`${surah.arti} • ${surah.tempatTurun} • ${surah.jumlahAyat} ayat`}
>
  <main class="mx-auto w-full max-w-4xl px-4 py-10 md:px-6">
    <header class="mb-8">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-xs font-medium tracking-wide text-muted-foreground">
            Surah {surah.nomor}
          </p>
          <h1 class="mt-2 text-3xl font-semibold">{surah.namaLatin}</h1>
          <p class="mt-2 text-sm text-muted-foreground">
            {surah.arti} • {surah.tempatTurun} • {surah.jumlahAyat} ayat
          </p>
        </div>

        <div class="text-right self-center">
          <div class="text-3xl font-semibold text-primary">{surah.nama}</div>
        </div>
      </div>
    </header>

    <div class="mb-6">
      <AudioPlayer client:idle audioFull={surah.audioFull} />
    </div>

    <div class="space-y-6">
      {surah.ayat.map((a) => (
        <article class="rounded-2xl border border-border/60 bg-card p-5">
          <div class="flex items-center justify-between">
            <span class="text-xs text-muted-foreground">Ayat {a.nomorAyat}</span>
          </div>

          <p class="mt-4 text-right text-2xl leading-relaxed">{a.teksArab}</p>
          <p class="mt-3 text-sm text-muted-foreground">{a.teksLatin}</p>
          <p class="mt-3 text-sm leading-relaxed">{a.teksIndonesia}</p>
        </article>
      ))}
    </div>

    <div class="mt-8 flex flex-col gap-2 sm:flex-row sm:items-stretch">
      {prevId ? (
        <a
          href={`/quran/${prevId}`}
          class="inline-flex min-w-[200px] flex-col rounded-lg border border-border/60 px-4 py-3 text-left transition hover:border-border hover:bg-accent sm:mr-auto"
        >
          <span class="block text-sm text-muted-foreground">Sebelumnya</span>
          <span class="block text-base font-semibold">{prevName}</span>
        </a>
      ) : null}

      {nextId ? (
        <a
          href={`/quran/${nextId}`}
          class="inline-flex min-w-[200px] flex-col rounded-lg border border-border/60 px-4 py-3 text-left transition hover:border-border hover:bg-accent sm:ml-auto sm:text-right"
        >
          <span class="block text-sm text-muted-foreground">Selanjutnya</span>
          <span class="block text-base font-semibold">{nextName}</span>
        </a>
      ) : null}
    </div>
  </main>
</Layout>
